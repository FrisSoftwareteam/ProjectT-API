<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        // ------------------------------
        // 0) ADMIN / RBAC MINIMUM
        // ------------------------------
        Schema::create('departments', function (Blueprint $t) {
            $t->id();
            $t->string('division', 100);
            $t->string('name', 100);
            $t->foreignId('parent_dept_id')->nullable()->constrained('departments')->cascadeOnUpdate()->restrictOnDelete();
            $t->boolean('is_branch')->default(false);
            $t->timestamps();
        });

        Schema::create('positions', function (Blueprint $t) {
            $t->id();
            $t->string('title', 100);
            $t->string('grade_level', 10)->nullable();
            $t->unsignedBigInteger('approval_limit_policy_id')->nullable();
            $t->timestamps();
        });

        Schema::create('user_activity_logs', function (Blueprint $t) {
            $t->id();
            $t->foreignId('user_id')->constrained('admin_users')->cascadeOnUpdate()->restrictOnDelete();
            $t->string('action', 255);
            $t->json('metadata')->nullable();
            $t->timestamp('created_at')->useCurrent();
        });

        Schema::create('user_kyc_documents', function (Blueprint $t) {
            $t->id();
            $t->foreignId('user_id')->constrained('admin_users')->cascadeOnUpdate()->restrictOnDelete();
            $t->string('document_type', 100);
            $t->string('file_ref', 255)->nullable();
            $t->enum('status', ['pending','approved','rejected'])->default('pending');
            $t->foreignId('reviewed_by')->nullable()->constrained('admin_users')->cascadeOnUpdate()->restrictOnDelete();
            $t->timestamp('reviewed_at')->nullable();
            $t->timestamps();
        });

        // ------------------------------
        // 1) COMPANIES / REGISTERS / CLASSES
        // ------------------------------
        Schema::create('companies', function (Blueprint $t) {
            $t->id();
            $t->string('issuer_code', 32)->unique();
            $t->string('name', 255);
            $t->string('rc_number', 50)->nullable();
            $t->string('tin', 50)->nullable();
            $t->enum('status', ['active','suspended','closed'])->default('active');
            $t->timestamps();
        });

        Schema::create('registers', function (Blueprint $t) {
            $t->id();
            $t->foreignId('company_id')->constrained('companies')->cascadeOnUpdate()->restrictOnDelete();
            $t->string('register_code', 32);
            $t->string('name', 255);
            $t->boolean('is_default')->default(true);
            $t->enum('status', ['active','closed'])->default('active');
            $t->timestamps();
            $t->unique(['company_id','register_code']);
        });

        Schema::create('share_classes', function (Blueprint $t) {
            $t->id();
            $t->foreignId('register_id')->constrained('registers')->cascadeOnUpdate()->restrictOnDelete();
            $t->string('class_code', 32);
            $t->char('currency', 3)->default('NGN');
            $t->decimal('par_value', 18, 6)->default(0);
            $t->string('description', 255)->nullable();
            $t->timestamps();
            $t->unique(['register_id','class_code']);
        });

        // ------------------------------
        // 2) SHAREHOLDER MASTER
        // ------------------------------
        Schema::create('shareholders', function (Blueprint $t) {
            $t->id();
            $t->string('account_no', 20)->unique();
            $t->enum('holder_type', ['individual','corporate']);
            $t->string('full_name', 255);
            $t->string('email', 255)->unique();
            $t->string('phone', 32)->unique();
            $t->date('date_of_birth')->nullable();
            $t->string('rc_number', 50)->nullable();
            $t->string('nin', 20)->nullable();
            $t->string('bvn', 20)->nullable();
            $t->string('tax_id', 50)->nullable();
            $t->enum('status', ['active','dormant','deceased','closed'])->default('active');
            $t->timestamps();
        });

        Schema::create('shareholder_identities', function (Blueprint $t) {
            $t->id();
            $t->foreignId('shareholder_id')->constrained('shareholders')->cascadeOnUpdate()->restrictOnDelete();
            $t->enum('id_type', ['passport','drivers_license','nin','bvn','cac_cert','other']);
            $t->string('id_value', 100);
            $t->date('issued_on')->nullable();
            $t->date('expires_on')->nullable();
            $t->enum('verified_status', ['pending','verified','rejected'])->default('pending');
            $t->foreignId('verified_by')->nullable()->constrained('admin_users')->cascadeOnUpdate()->restrictOnDelete();
            $t->timestamp('verified_at')->nullable();
            $t->string('file_ref', 255)->nullable();
            $t->timestamps();
            $t->unique(['shareholder_id','id_type','id_value']);
        });

        Schema::create('shareholder_addresses', function (Blueprint $t) {
            $t->id();
            $t->foreignId('shareholder_id')->constrained('shareholders')->cascadeOnUpdate()->restrictOnDelete();
            $t->string('address_line1', 255);
            $t->string('address_line2', 255)->nullable();
            $t->string('city', 100)->nullable();
            $t->string('state', 100)->nullable();
            $t->string('postal_code', 20)->nullable();
            $t->string('country', 100)->default('Nigeria');
            $t->boolean('is_primary')->default(true);
            $t->date('valid_from')->nullable();
            $t->date('valid_to')->nullable();
            $t->timestamps();
        });

        Schema::create('shareholder_bank_mandates', function (Blueprint $t) {
            $t->id();
            $t->foreignId('shareholder_id')->constrained('shareholders')->cascadeOnUpdate()->restrictOnDelete();
            $t->string('bank_name', 150);
            $t->string('account_name', 255);
            $t->string('account_number', 20);
            $t->string('bvn', 20)->nullable();
            $t->enum('status', ['pending','verified','active','rejected','revoked'])->default('pending');
            $t->foreignId('verified_by')->nullable()->constrained('admin_users')->cascadeOnUpdate()->restrictOnDelete();
            $t->timestamp('verified_at')->nullable();
            $t->timestamps();
            $t->unique(['shareholder_id','bank_name','account_number']);
        });

        // ------------------------------
        // 3) REGISTER ACCOUNTS & HOLDINGS
        // ------------------------------
        Schema::create('shareholder_register_accounts', function (Blueprint $t) {
            $t->id();
            $t->foreignId('shareholder_id')->constrained('shareholders')->cascadeOnUpdate()->restrictOnDelete();
            $t->foreignId('register_id')->constrained('registers')->cascadeOnUpdate()->restrictOnDelete();
            $t->string('shareholder_no', 30)->nullable();
            $t->string('chn', 50)->nullable();
            $t->string('cscs_account_no', 50)->nullable();
            $t->enum('residency_status', ['resident','non_resident'])->default('resident');
            $t->enum('kyc_level', ['basic','standard','enhanced'])->default('basic');
            $t->enum('status', ['active','suspended','closed'])->default('active');
            $t->timestamps();
            $t->unique(['shareholder_id','register_id']);
            $t->index('cscs_account_no');
            $t->index('chn');
        });

        Schema::create('share_positions', function (Blueprint $t) {
            $t->id();
            $t->foreignId('sra_id')->constrained('shareholder_register_accounts')->cascadeOnUpdate()->restrictOnDelete();
            $t->foreignId('share_class_id')->constrained('share_classes')->cascadeOnUpdate()->restrictOnDelete();
            $t->decimal('quantity', 28, 6)->default(0);
            $t->enum('holding_mode', ['demat','paper']);
            $t->timestamp('last_updated_at')->useCurrent();
            $t->timestamps();
            $t->unique(['sra_id','share_class_id']);
        });

        Schema::create('share_lots', function (Blueprint $t) {
            $t->id();
            $t->foreignId('sra_id')->constrained('shareholder_register_accounts')->cascadeOnUpdate()->restrictOnDelete();
            $t->foreignId('share_class_id')->constrained('share_classes')->cascadeOnUpdate()->restrictOnDelete();
            $t->string('lot_ref', 64);
            $t->enum('source_type', ['allotment','bonus','rights','transfer_in','demat_in','certificate_deposit']);
            $t->decimal('quantity', 28, 6);
            $t->timestamp('acquired_at');
            $t->enum('status', ['open','moved','closed'])->default('open');
            $t->timestamps();
            $t->unique(['sra_id','share_class_id','lot_ref']);
        });

        Schema::create('share_transactions', function (Blueprint $t) {
            $t->id();
            $t->foreignId('sra_id')->constrained('shareholder_register_accounts')->cascadeOnUpdate()->restrictOnDelete();
            $t->foreignId('share_class_id')->constrained('share_classes')->cascadeOnUpdate()->restrictOnDelete();
            $t->enum('tx_type', ['allot','bonus','rights','transfer_in','transfer_out','demat_in','demat_out','consolidation','split','cancellation']);
            $t->decimal('quantity', 28, 6);
            $t->string('tx_ref', 64)->nullable();
            $t->timestamp('tx_date');
            $t->timestamp('created_at')->useCurrent();
            $t->foreignId('created_by')->nullable()->constrained('admin_users')->cascadeOnUpdate()->restrictOnDelete();
            $t->index(['sra_id','share_class_id','tx_date']);
            $t->index('tx_ref');
        });

        // ------------------------------
        // 4) CORPORATE ACTIONS & DIVIDENDS
        // ------------------------------
        Schema::create('corporate_actions', function (Blueprint $t) {
            $t->id();
            $t->foreignId('register_id')->constrained('registers')->cascadeOnUpdate()->restrictOnDelete();
            $t->enum('action_type', ['dividend','bonus','rights','split','consolidation']);
            $t->string('period_label', 50);
            $t->date('announcement_date')->nullable();
            $t->date('record_date')->nullable();
            $t->date('payment_date')->nullable();
            $t->decimal('cash_rate', 18, 6)->nullable(); // for dividends
            $t->decimal('scrip_ratio_num', 18, 6)->nullable();
            $t->decimal('scrip_ratio_den', 18, 6)->nullable();
            $t->enum('status', ['scheduled','approved','posted','closed'])->default('scheduled');
            $t->timestamps();
            $t->foreignId('created_by')->nullable()->constrained('admin_users')->cascadeOnUpdate()->restrictOnDelete();
        });

        Schema::create('dividend_entitlements', function (Blueprint $t) {
            $t->id();
            $t->foreignId('corporate_action_id')->constrained('corporate_actions')->cascadeOnUpdate()->restrictOnDelete();
            $t->foreignId('sra_id')->constrained('shareholder_register_accounts')->cascadeOnUpdate()->restrictOnDelete();
            $t->foreignId('share_class_id')->constrained('share_classes')->cascadeOnUpdate()->restrictOnDelete();
            $t->decimal('shares_eligible', 28, 6);
            $t->decimal('gross_amount', 28, 6);
            $t->decimal('tax_amount', 28, 6)->default(0);
            $t->decimal('net_amount', 28, 6);
            $t->string('control_no', 40);
            $t->enum('status', ['pending','approved','paid','reissued','escheated'])->default('pending');
            $t->timestamps();
            $t->unique(['corporate_action_id','sra_id','share_class_id'], 'uk_entitlement');
        });

        Schema::create('dividend_payments', function (Blueprint $t) {
            $t->id();
            $t->foreignId('entitlement_id')->constrained('dividend_entitlements')->cascadeOnUpdate()->restrictOnDelete();
            $t->enum('payout_mode', ['edividend','warrant','bank_transfer']);
            $t->foreignId('bank_mandate_id')->nullable()->constrained('shareholder_bank_mandates')->cascadeOnUpdate()->restrictOnDelete();
            $t->timestamp('paid_at')->nullable();
            $t->string('paid_ref', 64)->nullable();
            $t->enum('status', ['initiated','paid','failed','reversed'])->default('initiated');
            $t->timestamps();
            $t->foreignId('created_by')->nullable()->constrained('admin_users')->cascadeOnUpdate()->restrictOnDelete();
        });

        // ------------------------------
        // 5) RELATIONSHIPS & ESTATES
        // ------------------------------
        Schema::create('sra_joint_holders', function (Blueprint $t) {
            $t->id();
            $t->foreignId('sra_id')->constrained('shareholder_register_accounts')->cascadeOnUpdate()->restrictOnDelete();
            $t->foreignId('shareholder_id')->constrained('shareholders')->cascadeOnUpdate()->restrictOnDelete();
            $t->integer('sequence_no')->default(1);
            $t->enum('role', ['primary','joint'])->default('joint');
            $t->timestamps();
            $t->unique(['sra_id','shareholder_id']);
        });

        Schema::create('sra_guardians', function (Blueprint $t) {
            $t->id();
            $t->foreignId('sra_id')->constrained('shareholder_register_accounts')->cascadeOnUpdate()->restrictOnDelete();
            $t->string('guardian_name', 255);
            $t->string('guardian_contact', 255)->nullable();
            $t->string('document_ref', 255)->nullable();
            $t->date('valid_from')->nullable();
            $t->date('valid_to')->nullable();
            $t->timestamps();
        });

        Schema::create('sra_proxies', function (Blueprint $t) {
            $t->id();
            $t->foreignId('sra_id')->constrained('shareholder_register_accounts')->cascadeOnUpdate()->restrictOnDelete();
            $t->string('proxy_name', 255);
            $t->string('proxy_contact', 255)->nullable();
            $t->enum('scope', ['general','agm','egm','meeting_specific'])->default('meeting_specific');
            $t->date('valid_from');
            $t->date('valid_to')->nullable();
            $t->string('document_ref', 255)->nullable();
            $t->timestamps();
        });

        Schema::create('probate_cases', function (Blueprint $t) {
            $t->id();
            $t->foreignId('shareholder_id')->constrained('shareholders')->cascadeOnUpdate()->restrictOnDelete();
            $t->string('court_ref', 100);
            $t->string('executor_name', 255);
            $t->string('document_ref', 255)->nullable();
            $t->enum('status', ['pending','granted','distributed','closed'])->default('pending');
            $t->timestamp('opened_at')->useCurrent();
            $t->timestamp('closed_at')->nullable();
        });

        // ------------------------------
        // 6) ADMIN CHANGE & AUDIT (HOLDER-SCOPED)
        // ------------------------------
        Schema::create('shareholder_change_requests', function (Blueprint $t) {
            $t->id();
            $t->foreignId('shareholder_id')->constrained('shareholders')->cascadeOnUpdate()->restrictOnDelete();
            $t->enum('request_type', ['email_change','phone_change','address_change','bank_mandate','name_change','status_change','cscs_update','chn_update']);
            $t->json('payload_old');
            $t->json('payload_new');
            $t->string('reason', 255)->nullable();
            $t->enum('status', ['draft','submitted','verified','approved_level1','approved_level2','rejected','applied'])->default('submitted');
            $t->string('control_no', 40);
            $t->foreignId('submitted_by')->constrained('admin_users')->cascadeOnUpdate()->restrictOnDelete();
            $t->timestamp('submitted_at')->useCurrent();
            $t->timestamp('updated_at')->useCurrent()->useCurrentOnUpdate();
            $t->index(['shareholder_id','status']);
        });

        Schema::create('shareholder_change_approvals', function (Blueprint $t) {
            $t->id();
            $t->foreignId('change_request_id')->constrained('shareholder_change_requests')->cascadeOnUpdate()->restrictOnDelete();
            $t->unsignedInteger('level_no');
            $t->enum('decision', ['approved','rejected']);
            $t->foreignId('decided_by')->constrained('admin_users')->cascadeOnUpdate()->restrictOnDelete();
            $t->timestamp('decided_at')->useCurrent();
            $t->string('remarks', 255)->nullable();
            $t->unique(['change_request_id','level_no']);
        });

        Schema::create('shareholder_audit_events', function (Blueprint $t) {
            $t->id();
            $t->foreignId('shareholder_id')->constrained('shareholders')->cascadeOnUpdate()->restrictOnDelete();
            $t->enum('event_type', ['view_profile','export_profile','download_statement','create','update','delete']);
            $t->foreignId('actor_user_id')->constrained('admin_users')->cascadeOnUpdate()->restrictOnDelete();
            $t->json('event_payload')->nullable();
            $t->timestamp('created_at')->useCurrent();
            $t->index(['shareholder_id','created_at']);
        });

    }

    public function down(): void
    {
        // Drop in reverse order of dependencies

        Schema::dropIfExists('shareholder_audit_events');
        Schema::dropIfExists('shareholder_change_approvals');
        Schema::dropIfExists('shareholder_change_requests');

        Schema::dropIfExists('probate_cases');
        Schema::dropIfExists('sra_proxies');
        Schema::dropIfExists('sra_guardians');
        Schema::dropIfExists('sra_joint_holders');

        Schema::dropIfExists('dividend_payments');
        Schema::dropIfExists('dividend_entitlements');
        Schema::dropIfExists('corporate_actions');

        Schema::dropIfExists('share_transactions');
        Schema::dropIfExists('share_lots');
        Schema::dropIfExists('share_positions');
        Schema::dropIfExists('shareholder_register_accounts');

        Schema::dropIfExists('shareholder_bank_mandates');
        Schema::dropIfExists('shareholder_addresses');
        Schema::dropIfExists('shareholder_identities');
        Schema::dropIfExists('shareholders');

        Schema::dropIfExists('share_classes');
        Schema::dropIfExists('registers');
        Schema::dropIfExists('companies');

        Schema::dropIfExists('user_kyc_documents');
        Schema::dropIfExists('user_activity_logs');
        Schema::dropIfExists('positions');
        Schema::dropIfExists('departments');
    }
};
